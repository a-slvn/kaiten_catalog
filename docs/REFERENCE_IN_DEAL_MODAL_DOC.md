# Справочник в модальном окне карточки сделки

## Какие метрики отслеживаем
- Доля карточек, где заполнено хотя бы одно поле справочника.
- Сколько новых записей пользователи создают прямо из карточки.
- Что чаще используется: выбор из списка или создание новой записи.
- Сколько раз пользователи редактируют выбранные записи из карточки.
- Сколько ошибок возникает при сохранении данных карточки.

## User story

| Задачи (Как пользователь, я...) | Цель (Чтобы...) | Критерии готовности | Артефакты |
|---|---|---|---|
| Хочу добавить поле справочника в карточку сделки | Связать сделку с компанией, контактом или другой сущностью | Поле можно добавить через меню «+», оно появляется в карточке и доступно для заполнения | Модальное окно карточки, меню добавления полей |
| Хочу выбрать запись из справочника | Быстро привязать существующую запись к сделке | Поле показывает список, работает поиск, выбранная запись сохраняется в карточке | Поле выбора справочника |
| Хочу создать новую запись, если нужной нет | Не выходить из карточки и не терять контекст | Из поля можно сразу открыть форму создания, после сохранения запись автоматически подставляется в поле | Форма создания записи справочника |
| Хочу отредактировать выбранную запись | Исправить ошибку без переходов между разделами | У выбранной записи доступно редактирование, изменения сразу видны в карточке | Форма редактирования записи справочника |
| Хочу видеть основные данные выбранной записи | Проверить, что выбрал правильную сущность | После выбора отображаются ключевые поля записи | Блок отображения выбранной записи |
| Хочу, чтобы связанные поля заполнялись автоматически | Ускорить заполнение и снизить ручные ошибки | При выборе контакта система автоматически подставляет компанию, если она есть и поле компании пустое | Логика автозаполнения в карточке |

## Требования для FE
- Поле справочника можно добавить в карточку через меню действий.
- Поле поддерживает:
  - выбор из существующих записей;
  - поиск по списку;
  - создание новой записи из этого же окна;
  - редактирование выбранной записи.
- Если записей нет, пользователь видит пустое состояние и явный CTA на создание первой записи.
- Если по поиску ничего не найдено, пользователь видит сообщение и CTA на создание новой записи.
- После создания новой записи она сразу становится выбранной в поле.
- После редактирования выбранная запись остается привязанной к сделке.
- Для связки «Контакты -> Компании» действует автозаполнение компании при выборе контакта, если поле компании в карточке пустое.

## Ограничения текущего прототипа
- Каскадная фильтрация между связанными полями работает не во всех сценариях карточки.
- Редактирование множественного выбора в отдельных сценариях может вести себя упрощенно.

## Сценарии поведения

### Сценарий 1. Добавление поля справочника
1. Пользователь открывает карточку сделки.
2. Нажимает «+».
3. Выбирает нужное поле справочника.
4. Поле появляется в карточке и готово к заполнению.

### Сценарий 2. Выбор существующей записи
1. Пользователь открывает поле справочника.
2. Вводит текст для поиска.
3. Выбирает запись из списка.
4. Запись сохраняется в карточке, ниже отображаются ее ключевые данные.

### Сценарий 3. Создание новой записи из карточки
1. Пользователь не находит нужную запись в списке.
2. Нажимает «Создать запись».
3. Заполняет форму и сохраняет.
4. Новая запись автоматически подставляется в поле карточки.

### Сценарий 4. Редактирование выбранной записи
1. Пользователь выбирает запись в поле.
2. Открывает редактирование.
3. Вносит изменения и сохраняет.
4. Карточка продолжает ссылаться на эту запись с обновленными данными.

### Сценарий 5. Автозаполнение компании по контакту
1. Пользователь выбирает контакт в карточке.
2. Система находит компанию, привязанную к этому контакту.
3. Если поле компании в сделке пустое, оно заполняется автоматически.

## Итого
Справочник в модальном окне карточки работает как быстрый инструмент связей: пользователь может добавить поле, выбрать или создать запись, при необходимости отредактировать ее и продолжить работу со сделкой без перехода в другие разделы.
